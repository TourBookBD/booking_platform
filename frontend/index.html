<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourBook - Tourism Booking Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .service-card, .booking-card {
            background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .service-card:hover, .booking-card:hover {
            background: linear-gradient(145deg, #ffffff, #f1f5f9);
            border-color: #667eea;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .form-input {
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            animation: slideIn 0.3s forwards;
        }

        .notification.success {
            background-color: #4CAF50; /* Green */
            color: white;
        }

        .notification.error {
            background-color: #f44336; /* Red */
            color: white;
        }

        .notification.info {
            background-color: #2196F3; /* Blue */
            color: white;
        }

        @keyframes slideIn {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 9999px; /* Full rounded */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            text-transform: capitalize;
        }

        .status-confirmed { background-color: #d1fae5; color: #065f46; } /* green-100, green-800 */
        .status-pending { background-color: #fef3c7; color: #92400e; } /* yellow-100, yellow-800 */
        .status-cancelled { background-color: #fee2e2; color: #991b1b; } /* red-100, red-800 */
        .status-completed { background-color: #e0f2fe; color: #075985; } /* blue-100, blue-800 */

        /* Hide sections by default */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg fixed w-full top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <!-- Updated home button to set hash -->
                    <h1 class="text-2xl font-bold text-gray-800 cursor-pointer" id="homeNavBtn">TourBook</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Updated navigation buttons to set hash -->
                    <button id="myBookingsNavBtn" class="hidden text-gray-600 hover:text-gray-800 px-3 py-2 rounded-md" data-view="mybookings">My Bookings</button>
                    <button id="myBusinessNavBtn" class="hidden text-gray-600 hover:text-gray-800 px-3 py-2 rounded-md" data-view="mybusiness">My Business</button>
                    
                    <button id="loginBtn" class="text-gray-600 hover:text-gray-800 px-3 py-2 rounded-md">Login</button>
                    <button id="registerBtn" class="btn-primary text-white px-4 py-2 rounded-md">Register</button>
                    <div id="userMenu" class="hidden flex items-center">
                        <span id="userName" class="text-gray-600 mr-3 font-medium"></span>
                        <span id="userIdDisplay" class="text-gray-500 text-sm mr-3"></span>
                        <button id="logoutBtn" class="text-red-600 hover:text-red-800 font-medium">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Sections -->
    <!-- Home Section (Hero + Services Grid) -->
    <div id="homeSection" class="content-section pt-20">
        <!-- Hero Section -->
        <section class="gradient-bg pb-16 text-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h2 class="text-5xl font-bold mb-6">Discover Amazing Places</h2>
                <p class="text-xl mb-8 opacity-90">Book hotels, restaurants, rooms, and transportation for your perfect trip</p>
                <div class="flex flex-wrap justify-center space-x-2 sm:space-x-4 mb-8">
                    <button class="service-filter active bg-white text-gray-800 px-4 py-2 sm:px-6 sm:py-3 rounded-lg font-medium mb-2 sm:mb-0" data-filter="all">All Services</button>
                    <button class="service-filter bg-white bg-opacity-20 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-lg font-medium mb-2 sm:mb-0" data-filter="hotels">Hotels</button>
                    <button class="service-filter bg-white bg-opacity-20 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-lg font-medium mb-2 sm:mb-0" data-filter="restaurants">Restaurants</button>
                    <button class="service-filter bg-white bg-opacity-20 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-lg font-medium mb-2 sm:mb-0" data-filter="rooms">Rooms</button>
                    <button class="service-filter bg-white bg-opacity-20 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-lg font-medium mb-2 sm:mb-0" data-filter="transport">Transport</button>
                </div>
                <div class="relative max-w-lg mx-auto">
                    <input type="text" id="searchBar" placeholder="Search services by name, location, or description..." class="form-input w-full px-5 py-3 rounded-full text-gray-800 placeholder-gray-500 shadow-md focus:ring-2 focus:ring-blue-400">
                    <svg class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>
        </section>

        <!-- Services Grid -->
        <section class="py-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-8">
                    <h3 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">Available Services</h3>
                    <button id="addServiceBtn" class="hidden btn-primary text-white px-6 py-3 rounded-md shadow-md">Add New Service</button>
                </div>
                
                <div id="servicesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Services will be populated here -->
                    <p id="loadingMessage" class="col-span-full text-center text-gray-600">Loading services...</p>
                    <p id="noServicesMessage" class="col-span-full text-center text-gray-600 hidden">No services found for this category.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- My Bookings Section -->
    <div id="myBookingsSection" class="content-section pt-20 py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h3 class="text-3xl font-bold text-gray-800 mb-8">My Bookings</h3>
            <div id="myBookingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <p id="loadingMyBookings" class="col-span-full text-center text-gray-600">Loading your bookings...</p>
                <p id="noMyBookings" class="col-span-full text-center text-gray-600 hidden">You have no bookings yet.</p>
            </div>
        </div>
    </div>

    <!-- My Business Section -->
    <div id="myBusinessSection" class="content-section pt-20 py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h3 class="text-3xl font-bold text-gray-800 mb-8">Bookings for My Services</h3>
            <div id="businessBookingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <p id="loadingBusinessBookings" class="col-span-full text-center text-gray-600">Loading bookings for your services...</p>
                <p id="noBusinessBookings" class="col-span-full text-center text-gray-600 hidden">No bookings found for your services.</p>
            </div>
        </div>
    </div>


    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Login</h3>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="btn-primary text-white px-4 py-2 rounded-md flex-1">Login</button>
                    <button type="button" class="closeModal bg-gray-300 text-gray-700 px-4 py-2 rounded-md">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Register</h3>
            <form id="registerForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                    <input type="text" id="registerName" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="registerEmail" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="registerPassword" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="businessOwner" class="mr-2">
                        <span class="text-sm text-gray-700">Register as Business Owner</span>
                    </label>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="btn-primary text-white px-4 py-2 rounded-md flex-1">Register</button>
                    <button type="button" class="closeModal bg-gray-300 text-gray-700 px-4 py-2 rounded-md">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Service Modal -->
    <div id="addServiceModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 id="serviceModalTitle" class="text-2xl font-bold mb-6 text-gray-800">Add New Service</h3>
            <form id="addServiceForm">
                <input type="hidden" id="serviceId"> <!-- Hidden input for service ID when editing -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Service Name</label>
                        <input type="text" id="serviceName" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Service Type</label>
                        <select id="serviceType" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" required>
                            <option value="">Select Type</option>
                            <option value="hotels">Hotel</option>
                            <option value="restaurants">Restaurant</option>
                            <option value="rooms">Room for Rent</option>
                            <option value="transport">Transportation</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                        <input type="text" id="serviceLocation" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Price per Unit</label>
                        <input type="number" id="servicePrice" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" step="0.01" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="serviceDescription" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" rows="3" required></textarea>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Image URL</label>
                    <input type="url" id="serviceImage" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="https://example.com/image.jpg">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rating (1-5)</label>
                    <input type="number" id="serviceRating" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" min="1" max="5" step="0.1" value="4.0">
                </div>
                <div class="flex space-x-4">
                    <button type="submit" id="submitServiceBtn" class="btn-primary text-white px-4 py-2 rounded-md flex-1">Add Service</button>
                    <button type="button" class="closeModal bg-gray-300 text-gray-700 px-4 py-2 rounded-md">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Book Service: <span id="bookingServiceName" class="font-normal text-blue-700"></span></h3>
            <form id="bookingForm">
                <!-- Dynamic fields will be inserted here by JavaScript -->
                <div id="bookingFormFields">
                    <!-- Default fields for hotels/rooms -->
                    <div class="mb-4" id="checkInDateGroup">
                        <label class="block text-sm font-medium text-gray-700 mb-2" id="checkInDateLabel">Check-in Date</label>
                        <input type="date" id="checkInDate" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-4" id="checkOutDateGroup">
                        <label class="block text-sm font-medium text-gray-700 mb-2" id="checkOutDateLabel">Check-out Date</label>
                        <input type="date" id="checkOutDate" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-4" id="numberOfGuestsGroup">
                        <label class="block text-sm font-medium text-gray-700 mb-2" id="numberOfGuestsLabel">Number of Guests</label>
                        <select id="numberOfGuests" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" required>
                            <option value="1">1 Guest</option>
                            <option value="2">2 Guests</option>
                            <option value="3">3 Guests</option>
                            <option value="4">4 Guests</option>
                            <option value="5">5+ Guests</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4 text-lg font-semibold text-gray-800">
                    Estimated Total: <span id="estimatedPriceDisplay" class="text-blue-600">$0.00</span>
                    <p id="priceBreakdownDisplay" class="text-sm font-normal text-gray-600"></p>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Special Requirements</label>
                    <textarea id="specialRequirements" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" rows="3" placeholder="Any special requests..."></textarea>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="btn-primary text-white px-4 py-2 rounded-md flex-1">Book Now</button>
                    <button type="button" class="closeModal bg-gray-300 text-gray-700 px-4 py-2 rounded-md">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal (for Delete Service / Cancel Booking) -->
    <div id="confirmModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full mx-4 text-center">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Confirm Action</h3>
            <p id="confirmMessage" class="text-gray-700 mb-6">Are you sure you want to proceed?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmYesBtn" class="btn-primary text-white px-6 py-2 rounded-md">Yes</button>
                <button id="confirmNoBtn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-md">No</button>
            </div>
        </div>
    </div>


    <script>
        // --- Configuration ---
        const API_BASE_URL = 'http://localhost:5000/api'; // Your backend API base URL

        // --- Application State ---
        let currentUser = null; // Stores logged-in user data
        let currentToken = null; // Stores JWT token
        let services = []; // Stores all fetched services
        let filteredServices = []; // Stores services after filtering/searching
        let currentServiceForBooking = null; // Service object for the currently opened booking modal
        let isEditingService = false; // Flag to determine if Add Service modal is for editing
        // Removed currentView state, now derived from hash
        let pendingDeleteServiceId = null; // Stores ID of service to be deleted
        let pendingCancelBookingId = null; // Stores ID of booking to be cancelled

        // --- DOM Elements ---
        const homeNavBtn = document.getElementById('homeNavBtn'); // Renamed for clarity
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const userMenu = document.getElementById('userMenu');
        const userName = document.getElementById('userName');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const logoutBtn = document.getElementById('logoutBtn');
        const myBookingsNavBtn = document.getElementById('myBookingsNavBtn');
        const myBusinessNavBtn = document.getElementById('myBusinessNavBtn');
        const addServiceBtn = document.getElementById('addServiceBtn');
        const servicesGrid = document.getElementById('servicesGrid');
        const loadingMessage = document.getElementById('loadingMessage');
        const noServicesMessage = document.getElementById('noServicesMessage');
        const serviceFilters = document.querySelectorAll('.service-filter');
        const searchBar = document.getElementById('searchBar');

        // Main content sections
        const homeSection = document.getElementById('homeSection');
        const myBookingsSection = document.getElementById('myBookingsSection');
        const myBookingsGrid = document.getElementById('myBookingsGrid');
        const loadingMyBookings = document.getElementById('loadingMyBookings');
        const noMyBookings = document.getElementById('noMyBookings');

        const myBusinessSection = document.getElementById('myBusinessSection');
        const businessBookingsGrid = document.getElementById('businessBookingsGrid');
        const loadingBusinessBookings = document.getElementById('loadingBusinessBookings');
        const noBusinessBookings = document.getElementById('noBusinessBookings');


        // Modal Elements
        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        const addServiceModal = document.getElementById('addServiceModal');
        const bookingModal = document.getElementById('bookingModal');
        const closeModalBtns = document.querySelectorAll('.closeModal');
        const serviceModalTitle = document.getElementById('serviceModalTitle');
        const submitServiceBtn = document.getElementById('submitServiceBtn');
        const bookingServiceName = document.getElementById('bookingServiceName');

        // Booking Form Dynamic Fields
        const bookingFormFields = document.getElementById('bookingFormFields');
        const checkInDateGroup = document.getElementById('checkInDateGroup');
        const checkOutDateGroup = document.getElementById('checkOutDateGroup');
        const numberOfGuestsGroup = document.getElementById('numberOfGuestsGroup');
        const checkInDateLabel = document.getElementById('checkInDateLabel');
        const checkOutDateLabel = document.getElementById('checkOutDateLabel');
        const numberOfGuestsLabel = document.getElementById('numberOfGuestsLabel');
        const checkInDateInput = document.getElementById('checkInDate');
        const checkOutDateInput = document.getElementById('checkOutDate');
        const numberOfGuestsSelect = document.getElementById('numberOfGuests');
        const estimatedPriceDisplay = document.getElementById('estimatedPriceDisplay');
        const priceBreakdownDisplay = document.getElementById('priceBreakdownDisplay');


        // Confirmation Modal
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');


        // --- Helper Functions ---

        /**
         * Displays a temporary notification message.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'} type - The type of notification.
         */
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'none'; // Stop slideIn animation
                notification.style.opacity = '0'; // Start fading out
                setTimeout(() => {
                    notification.remove();
                }, 300); // Remove after fade out
            }, 3000); // Display for 3 seconds
        }

        /**
         * Generic function to make authenticated fetch requests.
         * @param {string} url - The API endpoint URL.
         * @param {object} options - Fetch options (method, headers, body).
         * @returns {Promise<object>} - The JSON response from the API.
         */
        async function fetchWithAuth(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
            };

            if (currentToken) {
                headers['Authorization'] = `Bearer ${currentToken}`;
            }

            const response = await fetch(url, { ...options, headers });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ msg: 'Unknown error' }));
                throw new Error(errorData.msg || 'Something went wrong with the API call.');
            }
            return response.json();
        }

        // --- Modal Functions ---
        function openModal(modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modal) {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
            // Reset forms when closing modals
            if (modal.id === 'loginModal') document.getElementById('loginForm').reset();
            if (modal.id === 'registerModal') document.getElementById('registerForm').reset();
            if (modal.id === 'addServiceModal') {
                document.getElementById('addServiceForm').reset();
                isEditingService = false; // Reset editing flag
                serviceModalTitle.textContent = 'Add New Service'; // Reset title
                submitServiceBtn.textContent = 'Add Service'; // Reset button text
                document.getElementById('serviceId').value = ''; // Clear hidden ID
            }
            if (modal.id === 'bookingModal') {
                document.getElementById('bookingForm').reset();
                // Remove event listeners when closing the modal to prevent multiple attachments
                checkInDateInput.removeEventListener('change', updateBookingPriceDisplay);
                checkOutDateInput.removeEventListener('change', updateBookingPriceDisplay);
                numberOfGuestsSelect.removeEventListener('change', updateBookingPriceDisplay);
            }
            if (modal.id === 'confirmModal') {
                pendingDeleteServiceId = null; // Clear pending delete ID
                pendingCancelBookingId = null; // Clear pending cancel ID
                // Reset confirm button listener to default after modal closes
                confirmYesBtn.removeEventListener('click', handleDeleteConfirmed);
                confirmYesBtn.removeEventListener('click', handleCancelConfirmed);
                // For safety, we'll rely on the calling function to set the correct listener.
            }
        }

        /**
         * Manages which content section is visible based on the provided view name.
         * Also triggers data fetching for the active view.
         * @param {string} viewName - The name of the view to show ('home', 'mybookings', 'mybusiness').
         */
        async function showView(viewName) {
            // Hide all sections first
            homeSection.classList.remove('active');
            myBookingsSection.classList.remove('active');
            myBusinessSection.classList.remove('active');

            // Show the requested section and fetch data
            if (viewName === 'home') {
                homeSection.classList.add('active');
                await fetchServices(document.querySelector('.service-filter.active').dataset.filter, searchBar.value);
            } else if (viewName === 'mybookings') {
                myBookingsSection.classList.add('active');
                await fetchMyBookings();
            } else if (viewName === 'mybusiness') {
                myBusinessSection.classList.add('active');
                await fetchBusinessBookings();
            }
        }

        /**
         * Handles changes to the URL hash to navigate between views.
         */
        function handleHashChange() {
            const hash = window.location.hash.replace('#', ''); // Get hash without '#'
            const view = hash || 'home'; // Default to 'home' if no hash
            showView(view);
        }

        // --- Authentication Functions ---

        /**
         * Checks local storage for a token and user data on page load.
         * Updates the UI accordingly.
         */
        function checkAuthStatus() {
            const storedToken = localStorage.getItem('tourbookToken');
            const storedUser = localStorage.getItem('tourbookUser');

            if (storedToken && storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    currentToken = storedToken;
                    updateUserInterface();
                } catch (error) {
                    console.error('Failed to parse stored user data:', error);
                    logout(); // Clear corrupted data
                }
            } else {
                updateUserInterface(); // Ensure UI is in logged-out state
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const data = await fetchWithAuth(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                currentUser = data.user;
                currentToken = data.token;
                localStorage.setItem('tourbookToken', currentToken);
                localStorage.setItem('tourbookUser', JSON.stringify(currentUser));

                updateUserInterface();
                closeModal(loginModal);
                showNotification('Login successful!', 'success');
                window.location.hash = '#home'; // Redirect to home after login

            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const fullName = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const isBusinessOwner = document.getElementById('businessOwner').checked;

            try {
                const data = await fetchWithAuth(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    body: JSON.stringify({ fullName, email, password, isBusinessOwner })
                });

                currentUser = data.user;
                currentToken = data.token;
                localStorage.setItem('tourbookToken', currentToken);
                localStorage.setItem('tourbookUser', JSON.stringify(currentUser));

                updateUserInterface();
                closeModal(registerModal);
                showNotification('Registration successful! You are now logged in.', 'success');
                window.location.hash = '#home'; // Redirect to home after registration

            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        function logout() {
            currentUser = null;
            currentToken = null;
            localStorage.removeItem('tourbookToken');
            localStorage.removeItem('tourbookUser');
            updateUserInterface();
            showNotification('Logged out successfully!', 'info');
            window.location.hash = '#home'; // Redirect to home after logout
        }

        /**
         * Updates the navigation bar and Add Service button based on login status and user role.
         */
        function updateUserInterface() {
            if (currentUser) {
                loginBtn.style.display = 'none';
                registerBtn.style.display = 'none';
                userMenu.classList.remove('hidden');
                userName.textContent = currentUser.fullName || currentUser.email.split('@')[0];
                userIdDisplay.textContent = `ID: ${currentUser.id.substring(0, 8)}...`; // Display first 8 chars of ID

                myBookingsNavBtn.classList.remove('hidden');
                if (currentUser.isBusinessOwner) {
                    addServiceBtn.classList.remove('hidden');
                    myBusinessNavBtn.classList.remove('hidden');
                } else {
                    addServiceBtn.classList.add('hidden');
                    myBusinessNavBtn.classList.add('hidden');
                }
            } else {
                loginBtn.style.display = 'block';
                registerBtn.style.display = 'block';
                userMenu.classList.add('hidden');
                addServiceBtn.classList.add('hidden');
                myBookingsNavBtn.classList.add('hidden');
                myBusinessNavBtn.classList.add('hidden');
            }
        }

        // --- Service Functions ---

        /**
         * Fetches services from the backend API.
         * @param {string} type - Optional service type filter.
         * @param {string} search - Optional search query.
         */
        async function fetchServices(type = 'all', search = '') {
            if (window.location.hash !== '#home' && window.location.hash !== '') return; // Only fetch if on home view

            loadingMessage.classList.remove('hidden');
            servicesGrid.innerHTML = ''; // Clear current services

            let url = `${API_BASE_URL}/services`;
            const params = new URLSearchParams();
            if (type && type !== 'all') {
                params.append('type', type);
            }
            if (search) {
                params.append('search', search);
            }
            if (params.toString()) {
                url += `?${params.toString()}`;
            }

            try {
                const data = await fetchWithAuth(url, { method: 'GET' });
                services = data; // Update global services array
                filteredServices = [...services]; // Reset filtered services
                renderServices();
            } catch (error) {
                showNotification(`Failed to load services: ${error.message}`, 'error');
                services = []; // Clear services on error
                filteredServices = [];
                renderServices();
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        async function handleAddService(e) {
            e.preventDefault();
            
            const serviceId = document.getElementById('serviceId').value;
            const name = document.getElementById('serviceName').value;
            const type = document.getElementById('serviceType').value;
            const location = document.getElementById('serviceLocation').value;
            const price = parseFloat(document.getElementById('servicePrice').value);
            const description = document.getElementById('serviceDescription').value;
            const image = document.getElementById('serviceImage').value;
            const rating = parseFloat(document.getElementById('serviceRating').value);

            const serviceData = { name, type, location, price, description, image, rating };

            try {
                let response;
                if (isEditingService && serviceId) {
                    // Update existing service
                    response = await fetchWithAuth(`${API_BASE_URL}/services/${serviceId}`, {
                        method: 'PUT',
                        body: JSON.stringify(serviceData)
                    });
                    showNotification('Service updated successfully!', 'success');
                } else {
                    // Add new service
                    response = await fetchWithAuth(`${API_BASE_URL}/services`, {
                        method: 'POST',
                        body: JSON.stringify(serviceData)
                    });
                    showNotification('Service added successfully!', 'success');
                }
                
                closeModal(addServiceModal);
                // Re-fetch and re-render based on current view (which is now handled by hash change)
                handleHashChange(); // Trigger re-render of current view
            } catch (error) {
                showNotification(`Operation failed: ${error.message}`, 'error');
            }
        }

        function filterAndSearchServices(type, search) {
            filteredServices = services.filter(service => {
                const matchesType = type === 'all' || service.type === type;
                const matchesSearch = search === '' || 
                                      service.name.toLowerCase().includes(search.toLowerCase()) ||
                                      service.location.toLowerCase().includes(search.toLowerCase()) ||
                                      service.description.toLowerCase().includes(search.toLowerCase());
                return matchesType && matchesSearch;
            });
            renderServices();
        }

        function setActiveFilter(activeBtn) {
            serviceFilters.forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-gray-800');
                btn.classList.add('bg-white', 'bg-opacity-20', 'text-white');
            });
            activeBtn.classList.add('active', 'bg-white', 'text-gray-800');
            activeBtn.classList.remove('bg-opacity-20', 'text-white');
        }

        /**
         * Renders the services currently in the `filteredServices` array.
         */
        function renderServices() {
            servicesGrid.innerHTML = ''; // Clear existing cards
            noServicesMessage.classList.add('hidden'); // Hide no services message by default

            if (filteredServices.length === 0) {
                noServicesMessage.classList.remove('hidden');
                return;
            }

            filteredServices.forEach(service => {
                const serviceCard = createServiceCard(service);
                servicesGrid.appendChild(serviceCard);
            });
        }

        /**
         * Creates an HTML card element for a given service.
         * @param {object} service - The service object.
         * @returns {HTMLElement} - The created service card element.
         */
        function createServiceCard(service) {
            const card = document.createElement('div');
            card.className = 'service-card rounded-lg overflow-hidden shadow-lg card-hover animate-fade-in';
            
            // Determine if the current user is the owner of this service
            const canManage = currentUser && currentUser.isBusinessOwner && service.ownerId === currentUser.id;

            let priceUnitText = 'night';
            if (service.type === 'restaurants') {
                priceUnitText = 'person';
            } else if (service.type === 'transport') {
                priceUnitText = 'person'; // Changed from 'day' to 'person' for transport
            }

            // Display average rating and review count
            const avgRating = service.averageRating ? service.averageRating.toFixed(1) : 'N/A';
            const reviewCount = service.reviewCount !== undefined ? service.reviewCount : 0;
            const reviewText = reviewCount === 1 ? 'review' : 'reviews';
            
            card.innerHTML = `
                <img src="${service.image}" alt="${service.name}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x200/cccccc/333333?text=No+Image';">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-xl font-bold text-gray-800">${service.name}</h4>
                        <span class="text-sm px-2 py-1 bg-blue-100 text-blue-800 rounded-full">${service.type.charAt(0).toUpperCase() + service.type.slice(1)}</span>
                    </div>
                    <p class="text-gray-600 mb-2">${service.location}</p>
                    <p class="text-gray-700 mb-4">${service.description}</p>
                    <div class="flex items-center mb-4">
                        <span class="text-yellow-500">★</span>
                        <span class="text-gray-600 ml-1">${avgRating}</span>
                        <span class="text-gray-500 text-sm ml-1">(${reviewCount} ${reviewText})</span>
                        <span class="text-2xl font-bold text-gray-800 ml-auto">$${service.price ? service.price.toFixed(2) : '0.00'}</span>
                        <span class="text-gray-600 text-sm">/${priceUnitText}</span>
                    </div>
                    <div class="flex space-x-2">
                        <button data-service-id="${service.id}" class="book-btn btn-primary text-white px-4 py-2 rounded-md flex-1">
                            Book Now
                        </button>
                        <a href="forum.html?serviceId=${service.id}" class="view-details-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex-1 text-center">
                            View Details
                        </a>
                        ${canManage ? `
                            <button data-service-id="${service.id}" class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-md">
                                Edit
                            </button>
                            <button data-service-id="${service.id}" class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md">
                                Delete
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Add event listeners directly to buttons within the card
            card.querySelector('.book-btn').addEventListener('click', () => bookService(service.id));
            // The 'View Details' button is an <a> tag, so it handles navigation directly via href
            if (canManage) {
                card.querySelector('.edit-btn').addEventListener('click', () => editService(service.id));
                card.querySelector('.delete-btn').addEventListener('click', () => confirmDeleteService(service.id));
            }

            return card;
        }

        // --- Frontend Price Calculation Helper ---
        /**
         * Calculates the estimated total price and a breakdown string for display on the frontend.
         * Mirrors the backend logic in calculateBookingPrice.
         * @param {object} service - The service object (needs price and type).
         * @param {string} checkInDate - YYYY-MM-DD format.
         * @param {string} checkOutDate - YYYY-MM-DD format.
         * @param {number} numberOfGuests - Number of guests.
         * @returns {{total: number, breakdown: string}} - Object with total price and breakdown string.
         */
        function calculateFrontendPriceDetails(service, checkInDate, checkOutDate, numberOfGuests = 1) {
            let total = 0;
            let breakdown = '';
            // Ensure pricePerUnit is a valid number, default to 0 if not
            const pricePerUnit = typeof service.price === 'number' ? service.price : 0; 
            const serviceType = service.type;

            const start = new Date(checkInDate);
            const end = new Date(checkOutDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const actualDays = diffDays === 0 ? 1 : diffDays; // Ensure at least 1 day for per-day services

            // If pricePerUnit is 0, or service type is missing, return default values
            if (pricePerUnit === 0 || !serviceType) {
                return { total: 0, breakdown: 'Price not available' };
            }

            switch (serviceType) {
                case 'hotels':
                case 'rooms':
                    total = actualDays * pricePerUnit;
                    breakdown = `${actualDays} night${actualDays > 1 ? 's' : ''} @ $${pricePerUnit.toFixed(2)}/night`;
                    break;
                case 'restaurants':
                    total = pricePerUnit * numberOfGuests;
                    breakdown = `${numberOfGuests} guest${numberOfGuests > 1 ? 's' : ''} @ $${pricePerUnit.toFixed(2)}/person`;
                    break;
                case 'transport':
                    // Assuming transport pricePerUnit is per person per ride/day
                    total = actualDays * pricePerUnit * numberOfGuests;
                    const guestsText = `${numberOfGuests} guest${numberOfGuests > 1 ? 's' : ''}`;
                    const daysText = `${actualDays} day${actualDays > 1 ? 's' : ''}`;
                    if (actualDays === 1) {
                        breakdown = `${guestsText} @ $${pricePerUnit.toFixed(2)}/person`; // For a single day trip
                    } else {
                        breakdown = `${guestsText} for ${daysText} @ $${pricePerUnit.toFixed(2)}/person/day`;
                    }
                    break;
                default:
                    total = pricePerUnit;
                    breakdown = `Price: $${pricePerUnit.toFixed(2)}`;
                    break;
            }

            return { total, breakdown };
        }


        // --- Booking Functions (Connected to Backend) ---

        function bookService(serviceId) {
            if (!currentUser) {
                showNotification('Please login to book services!', 'error');
                openModal(loginModal);
                return;
            }

            currentServiceForBooking = services.find(s => s.id === serviceId);
            if (currentServiceForBooking) {
                bookingServiceName.textContent = currentServiceForBooking.name;
                
                // Reset form fields
                document.getElementById('bookingForm').reset();
                const today = new Date().toISOString().split('T')[0];
                checkInDateInput.min = today;
                checkOutDateInput.min = today;

                // Dynamically adjust booking form fields based on service type
                const serviceType = currentServiceForBooking.type;

                // Show all by default, then hide/change as needed
                checkInDateGroup.classList.remove('hidden');
                checkOutDateGroup.classList.remove('hidden');
                numberOfGuestsGroup.classList.remove('hidden');

                checkInDateInput.required = true; // Default to required
                checkOutDateInput.required = true; // Default to required
                numberOfGuestsSelect.required = true; // Default to required

                checkInDateLabel.textContent = 'Check-in Date';
                checkOutDateLabel.textContent = 'Check-out Date';
                numberOfGuestsLabel.textContent = 'Number of Guests';

                // Specific adjustments
                if (serviceType === 'restaurants') {
                    checkOutDateGroup.classList.add('hidden'); // No check-out date for restaurants
                    checkInDateLabel.textContent = 'Reservation Date';
                    checkOutDateInput.required = false; // Not required for restaurants
                } else if (serviceType === 'transport') {
                    checkInDateLabel.textContent = 'Pickup Date';
                    checkOutDateLabel.textContent = 'Return Date (Optional)'; // Make return date optional for transport
                    checkOutDateInput.required = false; // Make it not required
                } else { // hotels, rooms
                    checkOutDateInput.required = true; // Ensure required for hotels/rooms
                }

                // Initial price calculation display
                updateBookingPriceDisplay();

                // Add event listeners for dynamic price update
                checkInDateInput.addEventListener('change', updateBookingPriceDisplay);
                checkOutDateInput.addEventListener('change', updateBookingPriceDisplay);
                numberOfGuestsSelect.addEventListener('change', updateBookingPriceDisplay);

                openModal(bookingModal);
            } else {
                showNotification('Service not found for booking.', 'error');
            }
        }

        /**
         * Updates the estimated price and breakdown in the booking modal.
         */
        function updateBookingPriceDisplay() {
            if (!currentServiceForBooking) return;

            const checkInDate = checkInDateInput.value;
            let checkOutDate = checkOutDateInput.value;
            const numberOfGuests = parseInt(numberOfGuestsSelect.value);

            // Handle cases where dates might not be relevant or provided yet
            if (currentServiceForBooking.type === 'restaurants' && !checkInDate) {
                estimatedPriceDisplay.textContent = '$0.00';
                priceBreakdownDisplay.textContent = '';
                return;
            }
            if (currentServiceForBooking.type === 'transport' && !checkInDate) {
                 estimatedPriceDisplay.textContent = '$0.00';
                priceBreakdownDisplay.textContent = '';
                return;
            }
            if ((currentServiceForBooking.type === 'hotels' || currentServiceForBooking.type === 'rooms') && (!checkInDate || !checkOutDate)) {
                 estimatedPriceDisplay.textContent = '$0.00';
                priceBreakdownDisplay.textContent = '';
                return;
            }

            // For restaurants, checkOutDate is effectively the same as checkInDate for calculation
            if (currentServiceForBooking.type === 'restaurants' && checkInDate) {
                checkOutDate = checkInDate;
            }
            // For transport, if checkOutDate is empty, assume single day
            if (currentServiceForBooking.type === 'transport' && !checkOutDate) {
                checkOutDate = checkInDate;
            }


            const { total, breakdown } = calculateFrontendPriceDetails(
                currentServiceForBooking,
                checkInDate,
                checkOutDate,
                numberOfGuests
            );

            estimatedPriceDisplay.textContent = `$${total.toFixed(2)}`;
            priceBreakdownDisplay.textContent = `(${breakdown})`;
        }


        async function handleBooking(e) {
            e.preventDefault();
            
            const checkInDate = document.getElementById('checkInDate').value;
            let checkOutDate = document.getElementById('checkOutDate').value; // Can be empty for transport/restaurants
            const numberOfGuests = parseInt(document.getElementById('numberOfGuests').value);
            const specialRequirements = document.getElementById('specialRequirements').value;

            if (!currentServiceForBooking) {
                showNotification('No service selected for booking.', 'error');
                return;
            }

            // Basic date validation for types that require it
            if (currentServiceForBooking.type === 'hotels' || currentServiceForBooking.type === 'rooms') {
                if (!checkInDate || !checkOutDate || new Date(checkInDate) >= new Date(checkOutDate)) {
                    showNotification('Please select valid check-in and check-out dates.', 'error');
                    return;
                }
            } else if (currentServiceForBooking.type === 'restaurants') {
                if (!checkInDate) { // Only reservation date needed
                    showNotification('Please select a reservation date.', 'error');
                    return;
                }
                checkOutDate = checkInDate; // For restaurants, checkOutDate can be same as checkInDate for backend consistency
            } else if (currentServiceForBooking.type === 'transport') {
                if (!checkInDate) {
                    showNotification('Please select a pickup date.', 'error');
                    return;
                }
                // If return date is not provided, assume it's a single-day trip
                if (!checkOutDate) {
                    checkOutDate = checkInDate;
                } else if (new Date(checkInDate) > new Date(checkOutDate)) {
                    showNotification('Return date cannot be before pickup date.', 'error');
                    return;
                }
            }


            const bookingData = {
                serviceId: currentServiceForBooking.id,
                checkInDate: checkInDate,
                checkOutDate: checkOutDate,
                numberOfGuests: numberOfGuests,
                specialRequirements: specialRequirements,
            };

            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/bookings`, {
                    method: 'POST',
                    body: JSON.stringify(bookingData)
                });
                
                closeModal(bookingModal);
                showNotification(`Booking confirmed for ${currentServiceForBooking.name}!`, 'success');
                // Re-fetch bookings if on the 'My Bookings' page
                if (window.location.hash === '#mybookings') {
                    await fetchMyBookings();
                } else if (window.location.hash === '#mybusiness') {
                    await fetchBusinessBookings();
                }

            } catch (error) {
                showNotification(`Booking failed: ${error.message}`, 'error');
            }
        }

        // --- My Bookings Dashboard ---

        async function fetchMyBookings() {
            if (!currentUser) {
                myBookingsGrid.innerHTML = '';
                noMyBookings.classList.remove('hidden');
                return;
            }
            loadingMyBookings.classList.remove('hidden');
            myBookingsGrid.innerHTML = '';
            noMyBookings.classList.add('hidden');

            try {
                const bookings = await fetchWithAuth(`${API_BASE_URL}/bookings/my`, { method: 'GET' });
                renderMyBookings(bookings);
            } catch (error) {
                showNotification(`Failed to load your bookings: ${error.message}`, 'error');
                myBookingsGrid.innerHTML = '';
                noMyBookings.classList.remove('hidden');
            } finally {
                loadingMyBookings.classList.add('hidden');
            }
        }

        function renderMyBookings(bookings) {
            myBookingsGrid.innerHTML = '';
            if (bookings.length === 0) {
                noMyBookings.classList.remove('hidden');
                return;
            }

            bookings.forEach(booking => {
                const card = document.createElement('div');
                card.className = 'booking-card rounded-lg overflow-hidden shadow-lg animate-fade-in';
                const service = booking.service || {}; // Ensure service exists

                // Calculate breakdown for display
                const { total, breakdown } = calculateFrontendPriceDetails( // <-- Get total here
                    service,
                    booking.checkInDate,
                    booking.checkOutDate,
                    booking.numberOfGuests
                );

                card.innerHTML = `
                    <img src="${service.image || 'https://placehold.co/400x200/cccccc/333333?text=No+Image'}" alt="${service.name || 'Service'}" class="w-full h-40 object-cover">
                    <div class="p-4">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">${service.name || 'Unknown Service'}</h4>
                        <p class="text-gray-600 text-sm mb-1">Location: ${service.location || 'N/A'}</p>
                        <p class="text-gray-600 text-sm mb-1">
                            ${service.type === 'restaurants' ? 'Reservation Date' : 'Check-in'}: ${new Date(booking.checkInDate).toLocaleDateString()}
                        </p>
                        ${service.type === 'hotels' || service.type === 'rooms' || (service.type === 'transport' && booking.checkInDate !== booking.checkOutDate) ? 
                            `<p class="text-gray-600 text-sm mb-1">
                                ${service.type === 'transport' ? 'Return Date' : 'Check-out'}: ${new Date(booking.checkOutDate).toLocaleDateString()}
                            </p>` : ''
                        }
                        <p class="text-gray-600 text-sm mb-2">Guests: ${booking.numberOfGuests}</p>
                        <div class="flex justify-between items-center mt-2">
                            <div>
                                <span class="text-lg font-bold text-gray-800">$${total.toFixed(2)}</span> <!-- Use total from frontend calculation -->
                                <p class="text-sm text-gray-600">(${breakdown})</p>
                            </div>
                            <span class="status-badge status-${booking.status}">${booking.status}</span>
                        </div>
                        ${booking.status !== 'cancelled' && booking.status !== 'completed' ? `
                            <button data-booking-id="${booking.id}" class="cancel-booking-btn bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md mt-4 w-full">
                                Cancel Booking
                            </button>
                        ` : ''}
                    </div>
                `;
                myBookingsGrid.appendChild(card);

                if (booking.status !== 'cancelled' && booking.status !== 'completed') {
                    card.querySelector('.cancel-booking-btn').addEventListener('click', () => confirmCancelBooking(booking.id));
                }
            });
        }

        // --- My Business Dashboard ---

        async function fetchBusinessBookings() {
            if (!currentUser || !currentUser.isBusinessOwner) {
                businessBookingsGrid.innerHTML = '';
                noBusinessBookings.classList.remove('hidden');
                return;
            }
            loadingBusinessBookings.classList.remove('hidden');
            businessBookingsGrid.innerHTML = '';
            noBusinessBookings.classList.add('hidden');

            try {
                const bookings = await fetchWithAuth(`${API_BASE_URL}/bookings/business`, { method: 'GET' });
                renderBusinessBookings(bookings);
            } catch (error) {
                showNotification(`Failed to load business bookings: ${error.message}`, 'error');
                businessBookingsGrid.innerHTML = '';
                noBusinessBookings.classList.remove('hidden');
            } finally {
                loadingBusinessBookings.classList.add('hidden');
            }
        }

        function renderBusinessBookings(bookings) {
            businessBookingsGrid.innerHTML = '';
            if (bookings.length === 0) {
                noBusinessBookings.classList.remove('hidden');
                return;
            }

            bookings.forEach(booking => {
                const card = document.createElement('div');
                card.className = 'booking-card rounded-lg overflow-hidden shadow-lg animate-fade-in';
                const service = booking.service || {};
                const booker = booking.user || {};

                // Calculate breakdown for display
                const { total, breakdown } = calculateFrontendPriceDetails( // <-- Get total here
                    service,
                    booking.checkInDate,
                    booking.checkOutDate,
                    booking.numberOfGuests
                );

                card.innerHTML = `
                    <div class="p-4">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">${service.name || 'Unknown Service'}</h4>
                        <p class="text-gray-600 text-sm mb-1">Booked by: ${booker.fullName || booker.email || 'N/A'}</p>
                        <p class="text-gray-600 text-sm mb-1">Service Type: ${service.type ? service.type.charAt(0).toUpperCase() + service.type.slice(1) : 'N/A'}</p>
                        <p class="text-gray-600 text-sm mb-1">Location: ${service.location || 'N/A'}</p>
                        <p class="text-gray-600 text-sm mb-1">
                            ${service.type === 'restaurants' ? 'Reservation Date' : 'Check-in'}: ${new Date(booking.checkInDate).toLocaleDateString()}
                        </p>
                        ${service.type === 'hotels' || service.type === 'rooms' || (service.type === 'transport' && booking.checkInDate !== booking.checkOutDate) ? 
                            `<p class="text-gray-600 text-sm mb-1">
                                ${service.type === 'transport' ? 'Return Date' : 'Check-out'}: ${new Date(booking.checkOutDate).toLocaleDateString()}
                            </p>` : ''
                        }
                        <p class="text-gray-600 text-sm mb-2">Guests: ${booking.numberOfGuests}</p>
                        <div class="flex justify-between items-center mt-2">
                            <div>
                                <span class="text-lg font-bold text-gray-800">$${total.toFixed(2)}</span> <!-- Use total from frontend calculation -->
                                <p class="text-sm text-gray-600">(${breakdown})</p>
                            </div>
                            <select data-booking-id="${booking.id}" class="status-select px-2 py-1 rounded-md border border-gray-300 bg-white text-sm">
                                <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </div>
                    </div>
                `;
                businessBookingsGrid.appendChild(card);

                // Add event listener for status change
                card.querySelector('.status-select').addEventListener('change', (e) => {
                    updateBookingStatus(booking.id, e.target.value);
                });
            });
        }

        async function updateBookingStatus(bookingId, newStatus) {
            try {
                await fetchWithAuth(`${API_BASE_URL}/bookings/${bookingId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: newStatus })
                });
                showNotification(`Booking ${bookingId.substring(0,8)}... status updated to ${newStatus}!`, 'success');
                await fetchBusinessBookings(); // Refresh business bookings
            } catch (error) {
                showNotification(`Failed to update booking status: ${error.message}`, 'error');
            }
        }


        // --- Service Management Functions (Connected to Backend) ---

        function editService(serviceId) {
            const service = services.find(s => s.id === serviceId);
            if (service) {
                isEditingService = true;
                serviceModalTitle.textContent = 'Edit Service';
                submitServiceBtn.textContent = 'Update Service';

                // Pre-fill the form with existing data
                document.getElementById('serviceId').value = service.id; // Set hidden ID
                document.getElementById('serviceName').value = service.name;
                document.getElementById('serviceType').value = service.type;
                document.getElementById('serviceLocation').value = service.location;
                document.getElementById('servicePrice').value = service.price;
                document.getElementById('serviceDescription').value = service.description;
                document.getElementById('serviceImage').value = service.image;
                document.getElementById('serviceRating').value = service.rating;
                
                openModal(addServiceModal);
            } else {
                showNotification('Service not found for editing.', 'error');
            }
        }

        function confirmDeleteService(serviceId) {
            pendingDeleteServiceId = serviceId;
            confirmMessage.textContent = 'Are you sure you want to delete this service? This action cannot be undone.';
            // Set the correct handler for the Yes button
            confirmYesBtn.removeEventListener('click', handleCancelConfirmed); // Remove other handlers
            confirmYesBtn.addEventListener('click', handleDeleteConfirmed);
            openModal(confirmModal);
        }

        async function handleDeleteConfirmed() {
            if (pendingDeleteServiceId) {
                try {
                    await fetchWithAuth(`${API_BASE_URL}/services/${pendingDeleteServiceId}`, {
                        method: 'DELETE'
                    });
                    showNotification('Service deleted successfully!', 'success');
                    closeModal(confirmModal);
                    // Re-fetch and re-render based on current view
                    handleHashChange(); // Trigger re-render of current view
                } catch (error) {
                    showNotification(`Failed to delete service: ${error.message}`, 'error');
                    closeModal(confirmModal);
                }
            }
        }

        function confirmCancelBooking(bookingId) {
            pendingCancelBookingId = bookingId;
            confirmMessage.textContent = 'Are you sure you want to cancel this booking? This action cannot be undone.';
            // Set the correct handler for the Yes button
            confirmYesBtn.removeEventListener('click', handleDeleteConfirmed); // Remove other handlers
            confirmYesBtn.addEventListener('click', handleCancelConfirmed);
            openModal(confirmModal);
        }

        async function handleCancelConfirmed() {
            if (pendingCancelBookingId) {
                try {
                    await fetchWithAuth(`${API_BASE_URL}/bookings/${pendingCancelBookingId}/status`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'cancelled' })
                    });
                    showNotification('Booking cancelled successfully!', 'success');
                    closeModal(confirmModal);
                    await fetchMyBookings(); // Refresh 'My Bookings'
                } catch (error) {
                    showNotification(`Failed to cancel booking: ${error.message}`, 'error');
                    closeModal(confirmModal);
                }
            }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            // Navigation buttons now set hash
            homeNavBtn.addEventListener('click', () => window.location.hash = '#home');
            myBookingsNavBtn.addEventListener('click', () => window.location.hash = '#mybookings');
            myBusinessNavBtn.addEventListener('click', () => window.location.hash = '#mybusiness');

            loginBtn.addEventListener('click', () => openModal(loginModal));
            registerBtn.addEventListener('click', () => openModal(registerModal));
            logoutBtn.addEventListener('click', logout);
            addServiceBtn.addEventListener('click', () => openModal(addServiceModal));

            // Modal Close
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    closeModal(e.target.closest('.modal'));
                });
            });

            // Forms
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('addServiceForm').addEventListener('submit', handleAddService);
            document.getElementById('bookingForm').addEventListener('submit', handleBooking);

            // Confirmation Modal Buttons (initial setup, handlers change dynamically)
            // confirmYesBtn.addEventListener('click', handleDeleteConfirmed); // Default, but will be overridden
            confirmNoBtn.addEventListener('click', () => closeModal(confirmModal));


            // Service Filters
            serviceFilters.forEach(filter => {
                filter.addEventListener('click', (e) => {
                    const filterType = e.target.dataset.filter;
                    setActiveFilter(e.target);
                    // Fetch services based on selected filter and current search query
                    fetchServices(filterType, searchBar.value);
                });
            });

            // Search Bar
            let searchTimeout;
            searchBar.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const currentFilter = document.querySelector('.service-filter.active').dataset.filter;
                    fetchServices(currentFilter, e.target.value);
                }, 500); // Debounce search input
            });

            // Close modals on outside click
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target);
                }
            });

            // Ensure check-out date is not before check-in date
            checkInDateInput.addEventListener('change', (e) => {
                checkOutDateInput.min = e.target.value;
                if (checkOutDateInput.value < e.target.value) {
                    checkOutDateInput.value = e.target.value;
                }
            });

            // Listen for hash changes to navigate views
            window.addEventListener('hashchange', handleHashChange);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            setupEventListeners();
            checkAuthStatus(); // Check if user is already logged in from previous session
            handleHashChange(); // Initial view based on hash or default to home
        });
    </script>
</body>
</html>
